<!DOCTYPE html>
<html lang="ko">
<meta charset="utf-8">
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>검색어 키워드 분석</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            padding: 0px;
            margin: 0px;
        }

        table {
            width: 100%;
            border: 1px solid #444444;
            border-collapse: collapse;
        }

        tr, td {
            border: 1px solid #444444;
            padding: 10px;
        }

        #year {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-evenly;
        }

        #month {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-evenly;
        }

        [class*='selected_'] {
            font-weight: bold;
            color: red;
        }


    </style>

</head>
<body>


<H2>검색어를 입력하세요</H2>
<input type="text" id="subject" name="subject">
<input type="button" id="button" onclick="add_subject()" value="전송">
<div id="subject_div">
    <h3> 지정된 검색어</h3>
</div>
<div id="filter_div"></div>
<div id="table_div"></div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

<script>
    let today = new Date();
    let get_year = today.getFullYear();
    let get_month = today.getMonth() + 1;

    let queryString = [];
    let month_id;
    let year_id;

    $(document).ready(function () {
        console.log("docu ready");
        make_filter();

        for (let i = 0; i < 3; i++) {
            let id = "year" + i;
            $(document).on("click",
                "#" + id,
                function () {
                    event.preventDefault();
                    document.querySelectorAll(".selected_year").forEach(el => el.classList.remove("selected_year"));
                    document.getElementById(id).classList.toggle("selected_year");
                    year_id = get_year - i;
                    if (month_id !== undefined) {
                        queryString.forEach(element => to_api(year_id, month_id, element));
                    }

                });
        }

        for (let i = 1; i < 13; i++) {
            let id = "month" + i;
            $(document).on("click", "#" + id, function () {
                event.preventDefault();
                document.querySelectorAll(".selected_month").forEach(el => el.classList.remove("selected_month"));
                document.getElementById(id).classList.toggle("selected_month");
                month_id = i;
                if (year_id !== undefined) {
                    queryString.forEach(element => to_api(year_id, month_id, element));
                }
            });
        }
    });


    function make_filter() {
        let div0 = document.createElement("div");
        div0.id = 'year';
        let div1 = document.createElement("div");
        div1.id = 'month';

        for (let i = 0; i < 3; i++) {
            let filter_year = document.createElement("a");
            filter_year.appendChild(document.createTextNode(get_year - i + "년"));
            filter_year.id = "year" + i + "";
            div0.appendChild(filter_year);
        }
        for (let i = 1; i < 13; i++) {
            let filter_month = document.createElement("a");
            filter_month.appendChild(document.createTextNode(i + "월"));
            filter_month.id = "month" + i + "";
            div1.appendChild(filter_month);
        }

        $("#filter_div").append(div0);
        $("#filter_div").append(div1);

    }

    function to_table(json, subject) {

        let objValue = json['value'];
        let objLength = Object.keys(objValue).length;
        let arrDate = [];
        let arrValue = [];
        let arrExpect = [];
        arrDate[0] = "날짜";
        arrValue[0] = subject;
        arrExpect[0] = "예측";


        for (let i = 0; i < objLength; i++) {
            arrDate[i + 1] = i + 1 + "";
            arrValue[i + 1] = json["value"][i].toString();
            arrExpect[i + 1] = json["expect"][i];
        }

        const table = document.createElement("table");

        let tr0 = document.createElement("tr");
        let tr1 = document.createElement("tr");
        let tr2 = document.createElement("tr");

        for (let i = 0; i < arrDate.length; i++) {
            let td0 = document.createElement("td");
            td0.appendChild(document.createTextNode(arrDate[i]));

            let td1 = document.createElement("td");
            td1.appendChild(document.createTextNode(arrValue[i] + ""));

            let td2 = document.createElement("td");
            td2.appendChild(document.createTextNode(arrExpect[i]));

            tr0.appendChild(td0);
            tr1.appendChild(td1);
            tr2.appendChild(td2);

        }

        table.appendChild(tr0);
        table.appendChild(tr1);
        table.appendChild(tr2);

        return table;
    }

    function to_api(year, month, subject) {
        $("#" + subject).empty();
        let data = {
            subject: subject,
            year: year,
            month: month

        };

        $.ajax({
            url: '/post',
            data: JSON.stringify(data),
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            success: function (result) {
                let table = to_table(result, subject);
                table.id = "table_" + subject;
                table.className = subject;
                $("#" + subject).append(table);

            },
            error: function () {
                alert("Error!");
            }

        })

    }

    function add_subject() {
        let str_subject = $('#subject').val();
        $('#subject').val('');

        if (str_subject === "") {
            alert("검색어를 입력하세요");
            return;
        }

        if (queryString.includes(str_subject) === true) {
            return;
        }

        queryString.push(str_subject);
        console.log(queryString.toString());
        let subject_elem = document.createElement("p");
        subject_elem.id = "subject_" + str_subject;
        subject_elem.className = str_subject;
        subject_elem.append(document.createTextNode(str_subject));

        $("#subject_div").append(subject_elem);
        let table_section = document.createElement("div");
        table_section.id = str_subject;
        $("#table_div").append(table_section);

        if (year_id !== undefined && month_id !== undefined) {
            to_api(get_year, get_month, str_subject);

        }
        $(document).on("click",
            "#subject_" + str_subject,
            function () {
                $("#subject_" + str_subject).remove();
                $("#" + str_subject).remove();
                let temp = [];
                for (let i = 0; i < queryString.length; i++) {
                    if (queryString[i] !== str_subject) {
                        temp.push(queryString[i]);
                    }
                }
                queryString = temp;
                console.log(temp.toString());

            });

    }
</script>

</body>
</html>